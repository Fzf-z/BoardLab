"use strict";const n=require("electron"),E=require("path"),H=require("worker_threads"),L=require("electron-store"),U=require("puppeteer"),T=require("net");function Q(t,e,r){return new Promise(a=>{const s=new T.Socket,o=`[Config CMD: ${r}]`,d=setTimeout(()=>{s.destroy(),a({status:"error",message:`Timeout setting config. ${o}`})},2e3);s.connect(typeof e=="string"?parseInt(e):e,t,()=>{s.write(r.trim()+`
`,()=>{clearTimeout(d),s.end(),a({status:"success"})})}),s.on("error",g=>{clearTimeout(d),s.destroy(),a({status:"error",message:`${g.message}. ${o}`})})})}function K(t,e,r,a=2e3){return new Promise(s=>{const o=new T.Socket;let d="";const g=`[Measure CMD: ${r}]`,i=setTimeout(()=>{o.destroy(),s({status:"error",message:`Timeout getting measurement. ${g}`})},a);o.connect(typeof e=="string"?parseInt(e):e,t,()=>{o.write(r.trim()+`
`)}),o.on("data",M=>{if(d+=M.toString(),d.length>0){clearTimeout(i),o.destroy();const l=d.replace(/[^\x20-\x7E]/g,"").trim();s({status:"success",value:l})}}),o.on("error",M=>{clearTimeout(i),s({status:"error",message:`${M.message}. ${g}`})})})}function Y(t,e,r=4e3){return new Promise(a=>{let s=!1;const o=new T.Socket,d=setTimeout(()=>{o.destroy(),a({status:"error",message:"Timeout de conexión (4s)"})},r),g=[":WAV:SOUR CHAN1",":WAV:MODE NORM",":WAV:FORM BYTE",":CHAN1:SCAL?",":MEAS:VPP?",":MEAS:FREQ?",":WAV:PRE?",":WAV:DATA?"].join(`
`)+`
`;let i=Buffer.alloc(0);const M=()=>{if(!s){s=!0,clearTimeout(d),o.destroy();try{if(i.length===0)throw new Error("No se recibió respuesta alguna del instrumento.");const l=i.toString("ascii"),p=l.indexOf("#");if(p===-1)throw new Error("No se encontró el bloque de datos binarios (#). Buffer: "+i.toString("ascii").substring(0,100));const u=l.substring(0,p),w=u.trim().split(`
`).map(m=>m.trim()).filter(m=>m.length>0);if(w.length<4)throw new Error(`Se esperaban al menos 4 líneas de texto, recibidas ${w.length}. Buffer text: "${u}"`);const k=w[0],h=parseFloat(k),R=w[1];let b=parseFloat(R);(isNaN(b)||b>1e30)&&(b=0);const j=w[2];let S=parseFloat(j);(isNaN(S)||S>1e30)&&(S=0);const C=w[3],v=C.split(",");if(v.length<10)throw new Error(`Preamble incompleto: ${C}`);const I=parseFloat(v[4]),N=parseFloat(v[7]),q=parseFloat(v[8]),_=parseFloat(v[9]),$=l[p+1],F=parseInt($);if(isNaN(F))throw new Error("Error parseando el número de dígitos del bloque binario.");const W=p+2+F,D=i.subarray(W,i.length),A=[];for(let m=0;m<D.length;m++){if(D[m]===10&&m===D.length-1)continue;const B=(D[m]-_)*N+q;A.push(B)}const O=I*A.length/10;a({status:"success",waveform:A,timeScale:O,voltageScale:h,voltageOffset:q,vpp:b,freq:S})}catch(l){console.error("Error procesando datos Rigol:",l),a({status:"error",message:l.message})}}};o.connect(typeof e=="string"?parseInt(e):e,t,()=>{o.write(g)}),o.on("data",l=>{if(i=Buffer.concat([i,l]),i.length>50){const p=i.toString("ascii"),u=p.indexOf("#");if(u!==-1&&p.substring(0,u).trim().split(`
`).filter(h=>h.trim().length>0).length>=4){const h=parseInt(p[u+1]);if(!isNaN(h)&&p.length>=u+2+h){const R=p.substring(u+2,u+2+h),b=parseInt(R);if(!isNaN(b)){const j=u+2+h+b;i.length>=j&&M()}}}}}),o.on("error",l=>{clearTimeout(d),a({status:"error",message:l.message})}),o.on("end",()=>{M()})})}function z(t,e){return new Promise(r=>{const a=new T.Socket,s=setTimeout(()=>{a.destroy(),r({status:"error",message:"Timeout"})},2e3);a.connect(typeof e=="string"?parseInt(e):e,t,()=>{clearTimeout(s),a.end(),r({status:"success"})}),a.on("error",o=>{clearTimeout(s),r({status:"error",message:o.message})})})}const{generateReportHtml:G}=require("../src/report-generator"),f=new L;require("electron-squirrel-startup")&&n.app.quit();let y=null;const J=E.join(n.app.getPath("userData"),"boardlab.db"),x=new H.Worker(E.join(__dirname,"db-worker.js"),{workerData:{dbPath:J}}),P=new Map;let X=0;x.on("message",t=>{const{id:e,result:r,error:a}=t;if(P.has(e)){const{resolve:s,reject:o}=P.get(e);P.delete(e),a?(console.error("Database worker error:",a),o(new Error(a.message))):s(r)}});x.on("error",t=>console.error("DB worker error:",t));x.on("exit",t=>{t!==0&&console.error(`DB worker stopped with exit code ${t}`)});function c(t,e){return new Promise((r,a)=>{const s=X++;P.set(s,{resolve:r,reject:a}),x.postMessage({id:s,type:t,payload:e})})}function V(){y=new n.BrowserWindow({width:1400,height:900,webPreferences:{preload:E.join(__dirname,"preload.js"),nodeIntegration:!1,contextIsolation:!0}}),process.env.VITE_DEV_SERVER_URL?(console.log("Cargando aplicación desde Vite Server..."),y.loadURL(process.env.VITE_DEV_SERVER_URL)):(console.log("Cargando aplicación desde el build de producción..."),y.webContents.session.webRequest.onHeadersReceived((t,e)=>{const r=t.responseHeaders||{};r["Content-Security-Policy"]=["default-src 'self'; img-src 'self' data: blob:; script-src 'self'; style-src 'self' 'unsafe-inline'; connect-src 'self' ws:"],e({responseHeaders:r})}),y.loadFile(E.join(__dirname,"dist/index.html"))),y.on("closed",()=>{y=null})}n.app.on("ready",V);n.app.on("activate",()=>{n.BrowserWindow.getAllWindows().length===0&&V()});n.app.on("window-all-closed",()=>{c("close",void 0).finally(()=>{process.platform!=="darwin"&&n.app.quit()})});n.ipcMain.handle("db:get-projects",()=>c("db:get-projects",void 0));n.ipcMain.handle("db:get-project-with-image",(t,e)=>c("db:get-project-with-image",e));n.ipcMain.handle("db:create-project",(t,e)=>c("db:create-project",e));n.ipcMain.handle("db:get-all-attributes",()=>c("db:get-all-attributes",void 0));n.ipcMain.handle("db:save-points",(t,e)=>c("db:save-points",e));n.ipcMain.handle("db:get-points",(t,e)=>c("db:get-points",e));n.ipcMain.handle("db:save-measurement",(t,e)=>c("db:save-measurement",e));n.ipcMain.handle("db:createMeasurement",(t,e)=>c("db:createMeasurement",e));n.ipcMain.handle("db:getMeasurementsForPoint",(t,e)=>c("db:getMeasurementsForPoint",e));n.ipcMain.handle("db:delete-project",(t,e)=>c("db:delete-project",e));n.ipcMain.handle("db:delete-point",(t,e)=>c("db:delete-point",e));n.ipcMain.handle("db:update-project",(t,e)=>c("db:update-project",e));n.ipcMain.handle("hardware:measure-resistance",async()=>{});n.ipcMain.handle("multimeter-set-config",async(t,e)=>Q(e.ip,e.port,e.configCommand));n.ipcMain.handle("multimeter-get-measurement",async(t,e)=>K(e.ip,e.port,e.measureCommand,e.timeout));n.ipcMain.handle("measure-scope",async(t,e)=>Y(e.ip,e.port,e.timeout));n.ipcMain.handle("test-connection",async(t,{ip:e,port:r})=>z(e,r));n.ipcMain.handle("save-config",(t,e)=>f.set("instrumentConfig",e));n.ipcMain.handle("load-config",()=>f.get("instrumentConfig"));n.ipcMain.handle("save-api-key",(t,e)=>f.set("geminiApiKey",e));n.ipcMain.handle("load-api-key",()=>f.get("geminiApiKey"));n.ipcMain.handle("save-app-settings",(t,e)=>f.set("appSettings",e));n.ipcMain.handle("load-app-settings",()=>f.get("appSettings"));n.ipcMain.handle("exportPdf",async(t,e)=>{const{canceled:r,filePath:a}=await n.dialog.showSaveDialog({title:"Save Report as PDF",defaultPath:`boardlab-report-${e}-${Date.now()}.pdf`,filters:[{name:"PDF Documents",extensions:["pdf"]}]});if(r||!a)return{status:"cancelled"};try{const s=await c("db:get-project-with-image",e);if(!s)throw new Error(`Project with ID ${e} not found.`);const o=await c("db:get-points",e),d=G(s,o),g=await U.launch({headless:!0}),i=await g.newPage();return await i.setContent(d,{waitUntil:"networkidle0"}),await i.pdf({path:a,format:"A4",printBackground:!0}),await g.close(),{status:"success",filePath:a}}catch(s){return console.error("Failed to generate PDF:",s),{status:"error",message:s.message}}});n.ipcMain.handle("get-board-types",()=>{const t=["Laptop","Desktop","Industrial","Mobile","Other"],e=f.get("boardTypes",[]);return[...new Set([...t,...e])]});n.ipcMain.handle("add-board-type",(t,e)=>{if(!e)return;const r=f.get("boardTypes",[]);return r.includes(e)||f.set("boardTypes",[...r,e]),!0});
